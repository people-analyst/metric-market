// Spoke Cockpit â€” Metric Market
// Self-contained cockpit bundle. Usage: require('./spoke-cockpit').mount(app, pool);
// Generated 2026-02-21T02:10:06.204Z | Hub: http://localhost:5000
// UPDATED: SDK v2.0 - Enhanced monitoring and real-time capabilities

const HUB_URL = process.env.HUB_URL || "http://localhost:5000";
const HUB_API_KEY = process.env.HUB_API_KEY || "";
const APP_SLUG = "metric-market";
const APP_NAME = "Metric Market";
const COCKPIT_VERSION = "2.0.0";
const RECORD_INTERVAL_MS = parseInt(process.env.COCKPIT_INTERVAL_MS || "300000");
const METRIC_INTENTS = [{"key":"workflow_completion_rate","label":"Workflow Completion Rate","unit":"percent","domain":"strategic","category":"Performance Efficiency"},{"key":"avg_job_runtime_s","label":"Avg Job Runtime","unit":"duration_s","domain":"operational","category":"Performance Efficiency"},{"key":"retry_rate","label":"Retry Rate","unit":"percent","domain":"operational","category":"System Stability"},{"key":"workers_comp_premium_fte","label":"Workers' Comp Premium per FTE","unit":"currency","domain":"analytical","category":"Total Rewards"},{"key":"workers_comp_cost_fte","label":"Workers' Comp Cost per FTE","unit":"currency","domain":"analytical","category":"Total Rewards"},{"key":"workforce_age_avg","label":"Avg Workforce Age","unit":"years","domain":"analytical","category":"Headcount & Movement"},{"key":"avg_bonus_pct","label":"Avg Bonus % of Salary","unit":"percent","domain":"analytical","category":"Total Rewards"},{"key":"application_completion_rate","label":"Application Completion Rate","unit":"percent","domain":"analytical","category":"Talent Acquisition"},{"key":"union_headcount_pct","label":"Union Membership %","unit":"percent","domain":"analytical","category":"Company Health"},{"key":"interview_to_offer_ratio","label":"Interview-to-Offer Ratio","unit":"ratio","domain":"analytical","category":"Talent Acquisition"},{"key":"learning_satisfaction","label":"Learning Satisfaction Score","unit":"score","domain":"analytical","category":"Leadership & Development"},{"key":"bonus_penetration","label":"Bonus Penetration","unit":"percent","domain":"analytical","category":"Total Rewards"},{"key":"adr_pct","label":"ADR Resolution Rate","unit":"percent","domain":"analytical","category":"Company Health"},{"key":"avg_grievance_resolution","label":"Avg Grievance Resolution Time","unit":"days","domain":"analytical","category":"Company Health"},{"key":"yield_ratio","label":"Yield Ratio","unit":"percent","domain":"analytical","category":"Talent Acquisition"},{"key":"career_path_ratio","label":"Career Path Ratio","unit":"ratio","domain":"analytical","category":"Leadership & Development"},{"key":"overtime_cost","label":"Overtime Cost","unit":"currency","domain":"analytical","category":"Total Rewards"},{"key":"selection_ratio","label":"Selection Ratio","unit":"ratio","domain":"analytical","category":"Talent Acquisition"},{"key":"idp_completion","label":"IDP Completion Rate","unit":"percent","domain":"analytical","category":"Leadership & Development"},{"key":"applicants_per_opening","label":"Applicants per Opening","unit":"ratio","domain":"analytical","category":"Talent Acquisition"},{"key":"grievance_closed_pct","label":"Grievance Closure Rate","unit":"percent","domain":"analytical","category":"Company Health"},{"key":"contractor_ratio","label":"Contractor Ratio","unit":"percent","domain":"analytical","category":"Headcount & Movement"},{"key":"sourcing_channel_cost","label":"Sourcing Channel Cost","unit":"currency","domain":"analytical","category":"Talent Acquisition"},{"key":"pipeline_velocity","label":"Pipeline Velocity","unit":"days","domain":"analytical","category":"Talent Acquisition"},{"key":"recognition_frequency","label":"Recognition Frequency","unit":"ratio","domain":"analytical","category":"Survey & Engagement"},{"key":"retirement_rate","label":"Retirement Rate","unit":"percent","domain":"analytical","category":"Headcount & Movement"},{"key":"overtime_pct","label":"Overtime Percentage","unit":"percent","domain":"analytical","category":"Total Rewards"},{"key":"pto_utilization","label":"PTO Utilization","unit":"percent","domain":"analytical","category":"Company Health"},{"key":"grievance_pct","label":"Grievance Rate","unit":"percent","domain":"analytical","category":"Company Health"},{"key":"referral_hire_rate","label":"Referral Hire Rate","unit":"percent","domain":"analytical","category":"Talent Acquisition"},{"key":"recruiter_efficiency","label":"Recruiter Efficiency","unit":"ratio","domain":"operational","category":"Talent Acquisition"},{"key":"span_of_control","label":"Span of Control","unit":"ratio","domain":"analytical","category":"Headcount & Movement"},{"key":"merit_increase_pct","label":"Avg Merit Increase %","unit":"percent","domain":"analytical","category":"Total Rewards"},{"key":"payroll_expense_per_ee","label":"Payroll Expense per Employee","unit":"currency","domain":"operational","category":"HR Efficiency"},{"key":"avg_hours_worked_per_ee","label":"Avg Hours Worked per Employee","unit":"hours","domain":"analytical","category":"Company Health"},{"key":"source_channel_yield","label":"Source Channel Yield","unit":"percent","domain":"analytical","category":"Talent Acquisition"},{"key":"accession_rate","label":"Accession Rate","unit":"percent","domain":"analytical","category":"Headcount & Movement"},{"key":"data_quality_score","label":"Data Quality Score","unit":"score","domain":"strategic","category":"Analytical Output"},{"key":"candidate_experience_score","label":"Candidate Experience Score","unit":"score","domain":"analytical","category":"Talent Acquisition"},{"key":"promotion_rate","label":"Promotion Rate","unit":"percent","domain":"analytical","category":"Headcount & Movement"},{"key":"high_potential_pct","label":"High-Potential %","unit":"percent","domain":"analytical","category":"Leadership & Development"},{"key":"workers_comp_cost","label":"Workers' Compensation Cost","unit":"currency","domain":"analytical","category":"Company Health"},{"key":"healthcare_cost_per_ee","label":"Healthcare Cost per Employee","unit":"currency","domain":"analytical","category":"Total Rewards"},{"key":"avg_sick_days_fte","label":"Avg Sick Days per FTE","unit":"days","domain":"analytical","category":"Company Health"},{"key":"annualized_exit_rate","label":"Annualized Exit Rate","unit":"percent","domain":"analytical","category":"Headcount & Movement"},{"key":"internal_hire_rate","label":"Internal Hire Rate","unit":"percent","domain":"analytical","category":"Talent Acquisition"},{"key":"dei_perception_score","label":"DEI Perception Score","unit":"score","domain":"analytical","category":"Survey & Engagement"},{"key":"avg_headcount_sample","label":"Avg Headcount Sample","unit":"count","domain":"analytical","category":"Headcount & Movement"},{"key":"benefits_pct_total_comp","label":"Benefits % of Total Comp","unit":"percent","domain":"analytical","category":"Total Rewards"},{"key":"training_pct_payroll","label":"Training % of Payroll","unit":"percent","domain":"analytical","category":"Leadership & Development"},{"key":"active_users_7d","label":"Active Users (7d)","unit":"count","domain":"strategic","category":"User Activity"},{"key":"hr_staffing_coverage","label":"HR Staffing Coverage","unit":"ratio","domain":"operational","category":"HR Efficiency"},{"key":"wellbeing_index","label":"Wellbeing Index","unit":"score","domain":"analytical","category":"Survey & Engagement"},{"key":"internal_movement_rate","label":"Internal Movement Rate","unit":"percent","domain":"analytical","category":"Headcount & Movement"},{"key":"unscheduled_absence_per_ee","label":"Unscheduled Absence per Employee","unit":"days","domain":"analytical","category":"Company Health"},{"key":"diverse_candidate_slate","label":"Diverse Slate Rate","unit":"percent","domain":"analytical","category":"Talent Acquisition"},{"key":"hire_rate","label":"Hire Rate","unit":"percent","domain":"analytical","category":"Talent Acquisition"},{"key":"benefits_cost_per_ee","label":"Benefits Cost per Employee","unit":"currency","domain":"analytical","category":"Total Rewards"},{"key":"training_roi","label":"Training ROI","unit":"ratio","domain":"analytical","category":"Leadership & Development"},{"key":"self_service_penetration","label":"Self-Service Penetration","unit":"percent","domain":"operational","category":"HR Efficiency"},{"key":"belonging_index","label":"Belonging Index","unit":"score","domain":"analytical","category":"Survey & Engagement"},{"key":"data_freshness_seconds","label":"Data Freshness","unit":"duration_s","domain":"operational","category":"Operational Health"},{"key":"avg_absence_per_ee","label":"Avg Absence per Employee","unit":"days","domain":"analytical","category":"Company Health"},{"key":"new_hire_rate","label":"New Hire Rate","unit":"percent","domain":"analytical","category":"Headcount & Movement"},{"key":"involuntary_exit_rate","label":"Involuntary Exit Rate","unit":"percent","domain":"analytical","category":"Headcount & Movement"},{"key":"diversity_index","label":"Diversity Index","unit":"index","domain":"analytical","category":"Headcount & Movement"},{"key":"training_completion_rate","label":"Training Completion Rate","unit":"percent","domain":"analytical","category":"Leadership & Development"},{"key":"manager_trust_score","label":"Manager Trust Score","unit":"score","domain":"analytical","category":"Survey & Engagement"},{"key":"hr_operating_cost_pct","label":"HR Operating Cost %","unit":"percent","domain":"operational","category":"HR Efficiency"},{"key":"avg_time_lost_hs_incident","label":"Avg Time Lost per H&S Incident","unit":"days","domain":"analytical","category":"Company Health"},{"key":"time_to_productivity","label":"Time to Productivity","unit":"days","domain":"analytical","category":"Leadership & Development"},{"key":"vacancy_rate","label":"Vacancy Rate","unit":"percent","domain":"analytical","category":"Headcount & Movement"},{"key":"satisfaction_score","label":"Overall Satisfaction","unit":"score","domain":"analytical","category":"Survey & Engagement"},{"key":"avg_hr_cost_per_ee","label":"Avg HR Cost per Employee","unit":"currency","domain":"operational","category":"HR Efficiency"},{"key":"avg_cost_absence_fte","label":"Avg Cost of Absence per FTE","unit":"currency","domain":"analytical","category":"Company Health"},{"key":"new_hire_performance","label":"New Hire Performance","unit":"percent","domain":"analytical","category":"Talent Acquisition"},{"key":"range_penetration","label":"Range Penetration","unit":"percent","domain":"analytical","category":"Total Rewards"},{"key":"request_count","label":"Request Count (24h)","unit":"count","domain":"operational","category":"Operational Health"},{"key":"time_to_start","label":"Time to Start","unit":"days","domain":"analytical","category":"Talent Acquisition"},{"key":"survey_response_rate","label":"Survey Response Rate","unit":"percent","domain":"analytical","category":"Survey & Engagement"},{"key":"separation_rate","label":"Separation Rate","unit":"percent","domain":"analytical","category":"Headcount & Movement"},{"key":"external_complaint_factor","label":"External Complaint Factor","unit":"ratio","domain":"analytical","category":"Company Health"},{"key":"training_cost_per_ee","label":"Training Cost per Employee","unit":"currency","domain":"analytical","category":"Leadership & Development"},{"key":"direct_hr_cost_per_ee","label":"Direct HR Cost per Employee","unit":"currency","domain":"operational","category":"HR Efficiency"},{"key":"new_hire_retention_12mo","label":"12-Mo New Hire Retention","unit":"percent","domain":"analytical","category":"Talent Acquisition"},{"key":"manager_effectiveness","label":"Manager Effectiveness Score","unit":"score","domain":"analytical","category":"Leadership & Development"},{"key":"succession_coverage","label":"Succession Coverage","unit":"percent","domain":"strategic","category":"Leadership & Development"},{"key":"lost_time_incident_pct","label":"Lost Time Incident %","unit":"percent","domain":"analytical","category":"Company Health"},{"key":"hiring_roi","label":"Hiring ROI","unit":"ratio","domain":"strategic","category":"Talent Acquisition"},{"key":"avg_tenure","label":"Avg Tenure","unit":"years","domain":"analytical","category":"Headcount & Movement"},{"key":"quality_of_hire","label":"Quality of Hire","unit":"score","domain":"analytical","category":"Talent Acquisition"},{"key":"total_labor_cost","label":"Total Labor Cost","unit":"currency","domain":"strategic","category":"Total Rewards"},{"key":"leadership_bench_strength","label":"Leadership Bench Strength","unit":"percent","domain":"strategic","category":"Leadership & Development"},{"key":"commitment_index","label":"Commitment Index","unit":"score","domain":"analytical","category":"Survey & Engagement"},{"key":"payroll_error_pct","label":"Payroll Error Rate","unit":"percent","domain":"operational","category":"HR Efficiency"},{"key":"intent_to_stay","label":"Intent to Stay","unit":"score","domain":"analytical","category":"Survey & Engagement"},{"key":"first_year_exit_rate","label":"First-Year Exit Rate","unit":"percent","domain":"analytical","category":"Headcount & Movement"},{"key":"job_success_rate","label":"Job Success Rate","unit":"percent","domain":"operational","category":"Operational Health"},{"key":"avg_total_comp","label":"Avg Total Compensation","unit":"currency","domain":"analytical","category":"Total Rewards"},{"key":"profit_per_employee","label":"Profit per Employee","unit":"currency","domain":"strategic","category":"Total Rewards"},{"key":"offer_acceptance_rate","label":"Offer Acceptance Rate","unit":"percent","domain":"analytical","category":"Talent Acquisition"},{"key":"training_hours_per_ee","label":"Training Hours per Employee","unit":"hours","domain":"analytical","category":"Leadership & Development"},{"key":"avoidable_voluntary_exit_rate","label":"Avoidable Vol. Exit Rate","unit":"percent","domain":"analytical","category":"Headcount & Movement"},{"key":"pay_equity_ratio","label":"Pay Equity Ratio","unit":"ratio","domain":"analytical","category":"Total Rewards"},{"key":"enps","label":"Employee NPS","unit":"score","domain":"analytical","category":"Survey & Engagement"},{"key":"regretted_exit_rate","label":"Regretted Exit Rate","unit":"percent","domain":"analytical","category":"Headcount & Movement"},{"key":"hipo_retention","label":"High-Potential Retention","unit":"percent","domain":"strategic","category":"Leadership & Development"},{"key":"cost_per_hire","label":"Cost per Hire","unit":"currency","domain":"analytical","category":"Talent Acquisition"},{"key":"avg_salary","label":"Avg Salary","unit":"currency","domain":"analytical","category":"Total Rewards"},{"key":"absence_pct","label":"Absence Rate","unit":"percent","domain":"analytical","category":"Company Health"},{"key":"retention_rate","label":"Retention Rate","unit":"percent","domain":"strategic","category":"Headcount & Movement"},{"key":"voluntary_exit_rate","label":"Voluntary Exit Rate","unit":"percent","domain":"analytical","category":"Headcount & Movement"},{"key":"hr_fte_ratio","label":"HR-to-Employee Ratio","unit":"ratio","domain":"operational","category":"HR Efficiency"},{"key":"p95_latency_ms","label":"P95 Latency","unit":"duration_ms","domain":"operational","category":"Operational Health"},{"key":"engagement_score","label":"Engagement Score","unit":"score","domain":"analytical","category":"Survey & Engagement"},{"key":"time_to_fill","label":"Time to Fill","unit":"days","domain":"analytical","category":"Talent Acquisition"},{"key":"compa_ratio","label":"Compa-Ratio","unit":"ratio","domain":"analytical","category":"Total Rewards"},{"key":"exit_rate","label":"Exit Rate","unit":"percent","domain":"analytical","category":"Headcount & Movement"},{"key":"hc_roi","label":"Human Capital ROI","unit":"ratio","domain":"strategic","category":"Total Rewards"},{"key":"fte_count","label":"FTE Count","unit":"count","domain":"analytical","category":"Headcount & Movement"},{"key":"labor_cost_pct_revenue","label":"Labor Cost % Revenue","unit":"percent","domain":"strategic","category":"Total Rewards"},{"key":"activated_percent","label":"Activated %","unit":"percent","domain":"analytical","category":"Survey & Engagement"},{"key":"cams_index","label":"CAMS Index","unit":"score","domain":"analytical","category":"Survey & Engagement"},{"key":"error_rate","label":"Error Rate","unit":"percent","domain":"operational","category":"Operational Health"},{"key":"headcount","label":"Headcount","unit":"count","domain":"analytical","category":"Headcount & Movement"},{"key":"revenue_per_employee","label":"Revenue per Employee","unit":"currency","domain":"strategic","category":"Total Rewards"},{"key":"watchlist_utilization_pct","label":"Watchlist Utilization","unit":"percent","domain":"strategic","category":"User Activity"},{"key":"screener_queries_7d","label":"Screener Queries (7d)","unit":"count","domain":"strategic","category":"User Activity"},{"key":"metrics_tracked","label":"Metrics Tracked","unit":"count","domain":"strategic","category":"Strategic Insight"}];

async function ensureSchema(pool) {
  await pool.query(`CREATE TABLE IF NOT EXISTS spoke_metric_snapshots (id SERIAL PRIMARY KEY, app_slug TEXT NOT NULL, metric_key TEXT NOT NULL, value REAL NOT NULL, prior_value REAL, unit_type TEXT NOT NULL DEFAULT 'number', domain TEXT NOT NULL DEFAULT 'operational', classification TEXT DEFAULT 'Normal', confidence REAL, metadata JSONB DEFAULT '{}', recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL); CREATE INDEX IF NOT EXISTS idx_sms_key_time ON spoke_metric_snapshots (metric_key, recorded_at DESC); CREATE INDEX IF NOT EXISTS idx_sms_slug ON spoke_metric_snapshots (app_slug);`);
}

function classify(value, intent) { if (!intent) return "Normal"; const dir = intent.thresholdDirection || "higher_is_worse"; const isHighBad = dir === "higher_is_worse"; if (intent.critical != null && (isHighBad ? value >= intent.critical : value <= intent.critical)) return "Critical"; if (intent.alert != null && (isHighBad ? value >= intent.alert : value <= intent.alert)) return "Alert"; if (intent.watch != null && (isHighBad ? value >= intent.watch : value <= intent.watch)) return "Watch"; return "Normal"; }

let _pool = null;

async function recordSnapshot(metricKey, value, opts = {}) { if (!_pool) return; const intent = METRIC_INTENTS.find(i => i.key === metricKey); const unitType = opts.unitType || intent?.unit || "number"; const domain = opts.domain || intent?.domain || "operational"; const classification = classify(value, intent); const priorRes = await _pool.query("SELECT value FROM spoke_metric_snapshots WHERE metric_key = $1 AND app_slug = $2 ORDER BY recorded_at DESC LIMIT 1", [metricKey, APP_SLUG]); const priorValue = priorRes.rows.length > 0 ? priorRes.rows[0].value : null; await _pool.query("INSERT INTO spoke_metric_snapshots (app_slug, metric_key, value, prior_value, unit_type, domain, classification, confidence, metadata) VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9)", [APP_SLUG, metricKey, value, priorValue, unitType, domain, classification, opts.confidence || null, JSON.stringify(opts.metadata || {})]); }

async function getSnapshots(metricKey, limit = 50) { if (!_pool) return []; const res = await _pool.query("SELECT * FROM spoke_metric_snapshots WHERE metric_key = $1 AND app_slug = $2 ORDER BY recorded_at DESC LIMIT $3", [metricKey, APP_SLUG, limit]); return res.rows; }

async function getLatestSnapshots() { if (!_pool) return []; const res = await _pool.query("SELECT DISTINCT ON (metric_key) * FROM spoke_metric_snapshots WHERE app_slug = $1 ORDER BY metric_key, recorded_at DESC", [APP_SLUG]); return res.rows; }

async function getSparklineData(metricKey, points = 20) { if (!_pool) return []; const res = await _pool.query("SELECT value, recorded_at FROM spoke_metric_snapshots WHERE metric_key = $1 AND app_slug = $2 ORDER BY recorded_at DESC LIMIT $3", [metricKey, APP_SLUG, points]); return res.rows.reverse(); }

async function pushToHub(metrics) { try { const resp = await fetch(HUB_URL + "/api/hub/app/" + APP_SLUG + "/metrics", { method: "POST", headers: { "Content-Type": "application/json", "X-API-Key": HUB_API_KEY }, body: JSON.stringify(metrics) }); return { ok: resp.ok, status: resp.status }; } catch (e) { return { ok: false, error: e.message }; } }

async function fetchHubStatus() { try { const resp = await fetch(HUB_URL + "/api/hub/app/" + APP_SLUG + "/status", { headers: { "X-API-Key": HUB_API_KEY } }); if (!resp.ok) return { connected: false, error: "HTTP " + resp.status }; const data = await resp.json(); return { connected: true, ...data }; } catch (e) { return { connected: false, error: e.message }; } }

function mount(app, pool) {
  _pool = pool;
  ensureSchema(pool).catch(e => console.error("[spoke-cockpit] Schema setup error:", e.message));

  app.get("/api/cockpit/config", (_req, res) => { res.json({ appSlug: APP_SLUG, appName: APP_NAME, version: COCKPIT_VERSION, hubUrl: HUB_URL, intents: METRIC_INTENTS, recordIntervalMs: RECORD_INTERVAL_MS }); });

  app.post("/api/cockpit/metrics/record", async (req, res) => { try { const body = Array.isArray(req.body) ? req.body : [req.body]; for (const m of body) { if (m.metricKey && m.value != null) await recordSnapshot(m.metricKey, m.value, { unitType: m.unitType, domain: m.domain, confidence: m.confidence, metadata: m.metadata }); } res.json({ ok: true, recorded: body.length }); } catch (e) { res.status(500).json({ error: e.message }); } });

  app.get("/api/cockpit/metrics", async (req, res) => { try { const { key, limit } = req.query; if (key) { res.json(await getSnapshots(key, parseInt(limit) || 50)); } else { res.json(await getLatestSnapshots()); } } catch (e) { res.status(500).json({ error: e.message }); } });

  app.get("/api/cockpit/sparklines", async (req, res) => { try { const points = parseInt(req.query.points) || 20; const latest = await getLatestSnapshots(); const sparklines = {}; for (const m of latest) { sparklines[m.metric_key] = await getSparklineData(m.metric_key, points); } res.json(sparklines); } catch (e) { res.status(500).json({ error: e.message }); } });

  app.get("/api/cockpit/hub-status", async (_req, res) => { res.json(await fetchHubStatus()); });

  app.post("/api/cockpit/sync", async (_req, res) => { try { const latest = await getLatestSnapshots(); if (latest.length === 0) return res.json({ ok: true, synced: 0 }); const payload = latest.map(m => ({ metricKey: m.metric_key, value: m.value, priorValue: m.prior_value, unitType: m.unit_type, domain: m.domain, classification: m.classification, confidence: m.confidence, metadata: m.metadata })); const result = await pushToHub(payload); res.json({ ok: result.ok, synced: payload.length, hubStatus: result.status }); } catch (e) { res.status(500).json({ error: e.message }); } });

  app.get("/cockpit", async (_req, res) => {
    try {
      const [latest, hubStatus] = await Promise.all([getLatestSnapshots(), fetchHubStatus()]);
      const sparklines = {};
      for (const m of latest) { sparklines[m.metric_key] = await getSparklineData(m.metric_key, 20); }
      const metrics = latest || [];
      const metricCards = metrics.map(m => { const intent = METRIC_INTENTS.find(i => i.key === m.metric_key) || {}; const spark = (sparklines[m.metric_key] || []).map(s => s.value); const delta = m.prior_value != null ? ((m.value - m.prior_value) / (m.prior_value || 1) * 100).toFixed(1) : null; const statusColor = m.classification === "Critical" ? "#ef4444" : m.classification === "Alert" ? "#f59e0b" : m.classification === "Watch" ? "#eab308" : "#22c55e"; return { key: m.metric_key, label: intent.label || m.metric_key, value: m.value, unit: m.unit_type, delta, statusColor, classification: m.classification, spark, category: intent.category || "Uncategorized" }; });
      function groupByCategory(cards) { const groups = {}; for (const c of cards) { if (!groups[c.category]) groups[c.category] = []; groups[c.category].push(c); } return Object.entries(groups).map(([cat, items]) => '<div class="cat-header">' + cat + " (" + items.length + ")</div><div class=\"grid\">" + items.map(c => '<div class="card"><div class="top"><span class="lbl">' + c.label + '</span><span class="dot" style="background:' + c.statusColor + '"></span></div><div class="val-row"><span class="big">' + (typeof c.value === "number" ? c.value.toFixed(2) : c.value) + '</span><span class="unit">' + (c.unit || "") + "</span>" + (c.delta ? '<span class="delta ' + (parseFloat(c.delta) > 0 ? "up" : "down") + '">' + (parseFloat(c.delta) > 0 ? "+" : "") + c.delta + "%</span>" : "") + "</div></div>").join("") + "</div>").join(""); }
      const style = '<style>*{box-sizing:border-box;margin:0;padding:0}body{font-family:monospace;background:#0a0a0a;color:#e5e5e5;padding:16px}.header{display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid #333;padding-bottom:12px;margin-bottom:16px}.header h1{font-size:14px;color:#f59e0b;text-transform:uppercase;letter-spacing:2px}.header .meta{font-size:10px;color:#666}.hub-strip{display:flex;gap:16px;padding:8px 12px;background:#111;border:1px solid #333;border-radius:4px;margin-bottom:16px;font-size:11px;flex-wrap:wrap}.hub-strip .item{display:flex;flex-direction:column;gap:2px}.hub-strip .label{color:#888;text-transform:uppercase;font-size:9px}.hub-strip .val{color:#e5e5e5}.hub-strip .val.ok{color:#22c55e}.hub-strip .val.err{color:#ef4444}.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}.card{background:#111;border:1px solid #222;border-radius:4px;padding:12px}.card .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.card .lbl{font-size:10px;color:#888;text-transform:uppercase}.card .dot{width:6px;height:6px;border-radius:50%;display:inline-block}.card .val-row{display:flex;align-items:baseline;gap:8px}.card .big{font-size:22px;font-weight:700}.card .unit{font-size:11px;color:#666}.card .delta{font-size:11px}.card .delta.up{color:#ef4444}.card .delta.down{color:#22c55e}.cat-header{font-size:11px;color:#f59e0b;text-transform:uppercase;letter-spacing:1.5px;margin:20px 0 8px;border-bottom:1px solid #222;padding-bottom:4px}.footer{margin-top:24px;font-size:10px;color:#444;text-align:center}</style>';
      const hubStrip = '<div class="hub-strip"><div class="item"><span class="label">Hub</span><span class="val ' + (hubStatus.connected ? "ok" : "err") + '">' + (hubStatus.connected ? "Connected" : "Disconnected") + '</span></div><div class="item"><span class="label">SDK</span><span class="val">v' + COCKPIT_VERSION + '</span></div><div class="item"><span class="label">Intents</span><span class="val">' + METRIC_INTENTS.length + ' defined</span></div><div class="item"><span class="label">Recording</span><span class="val">' + metrics.length + ' active</span></div></div>';
      const html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Cockpit | ' + APP_NAME + '</title>' + style + '</head><body><div class="header"><h1>' + APP_NAME + ' Cockpit</h1><div class="meta">v' + COCKPIT_VERSION + '</div></div>' + hubStrip + groupByCategory(metricCards) + '<div class="footer">Spoke Cockpit ' + COCKPIT_VERSION + '</div></body></html>';
      res.type("html").send(html);
    } catch (e) { res.status(500).send('Cockpit error: ' + e.message); }
  });

  console.log("[spoke-cockpit] Mounted for " + APP_NAME + " (" + METRIC_INTENTS.length + " intents)");
}

module.exports = { mount, recordSnapshot, getSnapshots, getLatestSnapshots, pushToHub, fetchHubStatus, METRIC_INTENTS, APP_SLUG, COCKPIT_VERSION };